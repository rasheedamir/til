# SonarQube Analysis through pipeline

## Sonar Scanner instead of Jenkins Plugin
* The jenkins plugin exposes some methods that can be used in the pipeline but it needs to configured first which becomes sort of a manual step. 
* https://docs.sonarqube.org/display/SCAN/Analyzing+with+SonarQube+Scanner
* Sonar Scanner can trigger sonarqube analysis in the pipeline (Already present in stakater/pipeline-tools)
* If authentication is set up, scanner needs a token through `sonar.login` argument. The token can be generated by anyone logged in sonar. It should then be put as a secret for Jenkins to mount in the pod template which will run the stage. 
* Sonar scanner only triggers the analysis scan and does not wait for outcome. For that there is a [Build Breaker](https://github.com/SonarQubeCommunity/sonar-build-breaker). Unfortunately, the plugin isn't up to date but someone has forked and made it compatible with the latest version ([here](https://github.com/mstoecklmayr/sonar-build-breaker/tree/sonar-7.3)). This is already packaged and installed in stakater's sonarqube docker image.

## Test coverage statistics
* For test coverage statistics of Java applications, add `jacoco` maven plugin in your project. 
* https://docs.sonarqube.org/display/PLUG/Usage+of+JaCoCo+with+SonarJava
* https://github.com/SonarSource/sonar-scanning-examples/tree/master/sonarqube-scanner-maven

## How to run : 

```
    /bin/sonar-scanner \
        -Dsonar.host.url=${sonarQubeHost} \
        -Dsonar.login=\${SONARQUBE_TOKEN} \
        -Dsonar.projectKey=${project} \
        -Dsonar.projectVersion=${buildVersion} \
        -Dsonar.sources="src/main/java" \
        -Dsonar.tests="src/test/java" \
        -Dsonar.java.binaries="target/classes" \
        -Dsonar.junit.reportPaths="target/surefire-reports" \
        -Dsonar.jacoco.reportPaths="target/jacoco.exec" \
        -Dsonar.buildbreaker.alternativeServerUrl=${sonarQubeHost} \
        -Dsonar.buildbreaker.queryInterval=${sonarScanQueryInterval} \
        -Dsonar.buildbreaker.queryMaxAttempts=${sonarScanQueryMaxAttempts}
```

## NOTE
* Default Profiles and plugins can dissapear on container or sonarqube restart. It is highly recomemnded to volume mount sonarqube extensions directory (`/opt/app/sonarqube/extensions` for stakater image). 